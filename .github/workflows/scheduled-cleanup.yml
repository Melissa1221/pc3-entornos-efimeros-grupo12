name: Scheduled Auto Cleanup

on:
  schedule:
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      max_age_hours:
        description: 'Maximum age in hours for stacks'
        required: false
        default: '72'
        type: string
      dry_run:
        description: 'Run in dry-run mode (no actual cleanup)'
        required: false
        default: false
        type: boolean

env:
  TF_IN_AUTOMATION: true
  TF_INPUT: false

jobs:
  auto-cleanup:
    name: Automatic Stack Cleanup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false
      
      - name: Setup Docker
        uses: docker/setup-buildx-action@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
      
      - name: Run auto cleanup
        run: |
          max_age="${{ github.event.inputs.max_age_hours || '72' }}"
          dry_run_flag=""
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            dry_run_flag="--dry-run"
          fi
          
          echo "Running cleanup with max age: ${max_age}h"
          ./scripts/auto-cleanup.sh $max_age $dry_run_flag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify cleanup results
        run: |
          echo "Remaining ephemeral containers:"
          docker ps -a --filter "label=environment=ephemeral" --format "table {{.Names}}\t{{.Status}}\t{{.CreatedAt}}" || echo "No containers found"
          
          echo ""
          echo "Remaining ephemeral volumes:"
          docker volume ls --filter "name=ephemeral-pr-" --format "table {{.Name}}\t{{.Driver}}\t{{.CreatedAt}}" || echo "No volumes found"
      
      - name: Generate cleanup report
        if: always()
        run: |
          ./scripts/auto-cleanup.sh --report
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report
          path: cleanup_report_*.md
          retention-days: 30